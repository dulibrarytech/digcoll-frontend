name: run-tests

on: 
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  run-mocha-tests:
    runs-on: ubuntu-latest
    steps:

      # Elasticsearch
      - name: Configure sysctl limits
        run: |
          sudo swapoff -a
          sudo sysctl -w vm.swappiness=1
          sudo sysctl -w fs.file-max=262144
          sudo sysctl -w vm.max_map_count=262144

      - uses: getong/elasticsearch-action@v1.2
        with:
          elasticsearch version: '7.10.2'
          host port: 9200
          container port: 9200
          host node port: 9300
          node port: 9300
          discovery type: 'single-node'

      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1

      # Copy test .env file and append secret values
      # - run: mv test/.env.public .env
      # - run: mv test/cache .
      # - run: echo "" >> .env 
      # - run: echo "API_KEY="${{ secrets.API_KEY }} >> .env

      - run: |
          cd test
          openssl aes-256-cbc -K ${{ secrets.TEST_ENV_KEY }} -iv ${{ secrets.TEST_ENV_INITIAL_VECTOR }} -in .env.enc -out .env -d
          cd ..
          mv test/.env .
          mv test/cache .

      # Deploy app and run mocha tests
      - run: |
          npm install
          sudo apt update
          sudo apt install openjdk-8-jdk
          node discovery.js &
          sleep 10
          npm test
